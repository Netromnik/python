{% extends "admin/base_site.html" %}

{% load thumbnail i18n staticfiles media_utils admin_urls str_utils %}

{% block title %}Редактор соцсетей{% endblock %}

{% block breadcrumbs %}
    <div class="breadcrumbs">
        <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a> &rsaquo;
        <a href="{% url 'admin:app_list' app_label='news' %}">News</a>
        &rsaquo; Пульт соцсетей
    </div>
{% endblock %}

{% block extrastyle %}
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css">
    <link rel="stylesheet" href="{% static 'fileupload/css/jquery.fileupload.css' %}">
    <style>
        .fotorama__stage {
            background-color: black;
        }
        .fotorama__nav__frame--thumb.fotorama__active::after,
        .ass::after {
            font: normal 900 50px/1.2 Font Awesome\ 5 Free;
            content: "\f00c";
            color: blanchedalmond;
            display: inline-block;
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            top: 0;
            text-align: center;
        }
        #content h2 {
            font-size: 18px;
            font-weight: bold;
            padding: 0 6px 0 0;
            margin: 0 0 .2em 0;
        }
        .__active {
            background-color: steelblue;
        }
        .b-lenta .search-box {
            padding: 5px;
        }
        .b-lenta .search-input {
            width: 100%;
        }
        .b-undernav .navtext {
            line-height: 38px;
            margin-left: 20px;
        }
        .b-datepicker .day-input {
            width: 100px;
        }
        .b-datepicker a:first-child {
            display: none;
        }
        .b-datepicker .day-select {
            display: inline-block;
            width: 130px;
        }
        .b-datepicker .hour-select {
            display: inline-block;
            width: 67px;
        }
        .b-datepicker .minute-select {
            display: inline-block;
            width: 67px;
        }
        .b-datepicker .in {
            padding: 0 5px;
        }
    </style>
{% endblock %}

{% block extrahead %}
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    {{ block.super }}
    <script>
        // для работы datepicker
        window.adminIncludes[window.adminIncludes.length] = '{% url 'admin:jsi18n' %}';
    </script>

    <script src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
    <script src="{% static 'js/apps-js/admin.js' %}"></script>

    <!-- knockoutjs - синхронизатор JS <> UI -->
    <script src="{% static 'js/lib/knockout-3.4.2.js' %}"></script>

    <!-- datepicker -->
    <script src="{% static 'admin/js/calendar.js' %}"></script>
    <script src="{% static 'admin/js/core.js' %}"></script>
    <script src="{% static 'admin/js/admin/DateTimeShortcuts.js' %}"></script>

    <!-- upload -->
    <script src="{% static 'fileupload/js/vendor/jquery.ui.widget.js' %}"></script>
    <script src="{% static 'fileupload/js/jquery.iframe-transport.js' %}"></script>
    <script src="{% static 'fileupload/js/jquery.fileupload.js' %}"></script>

    <!-- bootstrap 4 - вроде бы и не нужен
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>-->

    <!-- fotorama.css & fotorama.js. -->
    <link  href="https://cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.css" rel="stylesheet"> <!-- 3 KB -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.js"></script> <!-- 16 KB -->

    <script>
        // глобальные
        var app;
        var LIST_NEWS_URL = "{% url 'admin_social_pult_list_news' %}";
        var LIST_SCHEDULED_URL = "{% url 'admin_social_pult_list_scheduled' %}";
        var LOAD_EDITOR_URL = "{% url 'admin_social_pult_load_editor' '000' %}";
        var SAVE_DRAFT_URL = "{% url 'admin_social_pult_save_draft' '000' %}";
        var PUBLISH_POST_URL = "{% url 'admin_social_pult_publish_post' '000' %}";
        var VIEW_POST_URL = "{% url 'admin_social_pult_view_post' '000' %}";
        var UPLOAD_IMAGE_URL = "{% url 'admin_social_pult_upload' '000' %}";

        var NOIMAGE_URL = "{% static 'news/img/noimage.png' %}";

        /**
         * Центральный объект, который хранит состояние приложения
         * и меняет состояние вьюшек (editor, lenta, viewer), которые уже
         * это состояние автоматически отображают в ХТМЛ через knockout
         */
        function App(){
            var self = this;

            self.init = function() {
                self.editor = editorViewModel;
                self.viewer = viewerViewModel;
                self.lenta = new lentaViewModel();
                self.progress = new progressViewModel();

                self.editor.app = self.viewer.app = self.lenta.app = self;

                ko.applyBindings(self.editor, document.getElementById('Editor'));
                ko.applyBindings(self.viewer, document.getElementById('Viewer'));
                ko.applyBindings(self.lenta, document.getElementById('Lenta'));
                ko.applyBindings(self.progress, document.getElementById('Progress'));

                self.lenta.init();

                self.initFileUploader();
            };

            /**
             * Загрузка своих медиафайлов через плагин jQuery Upload
             */
            self.initFileUploader = function() {
                var uploader = self.uploader = $('#fileupload').fileupload();

                uploader.bind('fileuploadadd', function(e, data){
                    $('#progress .progress-bar').css('width', '0');
                    self.editor.fileuploadError('');
                    data.url = self.editor.imageUploadUrl();

                });
                uploader.bind('fileuploadfail', function(e, data){
                    self.showHttpError(data.jqXHR);
                });
                uploader.bind('fileuploadprogressall', function(e, data){
                    var progress = parseInt(data.loaded / data.total * 100, 10);
                    $('#progress .progress-bar').css(
                        'width',
                        progress + '%'
                    );
                });
                uploader.bind('fileuploaddone', function(e, data){
                    if (data.result.ok === false) {
                        self.editor.fileuploadError(data.result.error_html);
                    } else if (data.result.ok === true) {
                        self.editor.fileuploadError('Файл успешно загружен');
                        // выведем загруженное фото в фотораме
                        self.reloadImages();
                    }
                });
            };

            self.showHttpError = function(xhr) {
                self.viewer.visible(0);
                self.editor.visible(0);

                if (xhr.status === 0) {
                    self.progress.errorHeader('Не удалось подключиться к серверу')
                    self.progress.errorText('Проверьте соединение с интернетом');
                } else {
                    self.progress.errorHeader(xhr.status + ' '+ xhr.statusText);
                    self.progress.errorText(xhr.responseText);
                }

                self.progress.visible(1);
            };

            self.openViewer = function(materialId, socialPultPostId) {
                var url = VIEW_POST_URL.replace('000', socialPultPostId);
                jQuery.getJSON(url)
                    .done(function(result){
                        self.progress.visible(0);
                        self.viewer.visible(1);
                        self.viewer.publishing(1);
                        self.editor.visible(0);

                        self.viewer.materialId(materialId);
                        self.viewer.socialPultPostId(socialPultPostId);

                        self.viewer.status(result.editor_status);
                        self.viewer.text(result.text);
                        self.viewer.twitterText(result.text_twitter);
                        self.viewer.url(result.url);
                        self.viewer.progress(result.progress);

                        var images = JSON.parse(result.selected_images);
                        self.viewer.selectedImage(images[0]);
                    })
                    .error(function(xhr){
                        self.showHttpError(xhr);
                    });
            };

            /**
             * После загрузки пользовательской фотки, запросить с сервера
             * данные social_pult_post и обновить фотораму.
             */
            self.reloadImages = function() {
                var materialId = self.editor.materialId();
                var url = LOAD_EDITOR_URL.replace('000', materialId);
                jQuery.getJSON(url)
                    .fail(self.showHttpError)
                    .done(function(result){
                        self.insertEditorImages(result.images);
                    });
            };

            self.insertEditorImages = function(images) {
                self.editor.images.removeAll();

                // первое изображение всегда "нет изображения"
                self.editor.images.push({
                    type: 'noimage',
                    id: 'noimage',
                    original: NOIMAGE_URL,
                });

                ko.utils.arrayPushAll(self.editor.images, images);
                // дальше фоторисуется через editorViewModel.images.subscribe
            };

            /**
             * Открывает в правой колонке редактор или просмотрщик,
             * в зависимости от статуса материала на сервере.
             */
            self.openEditor = function(materialId, force) {

                // принудительно открыть редактор (для повторного написания поста)
                force = force || 0;

                // подсветим пункт в ленте
                self.lenta.selectedId(materialId);

                self.viewer.visible(0);
                self.editor.visible(0);

                var url = LOAD_EDITOR_URL.replace('000', materialId);
                jQuery.getJSON(url)
                    .done(function(result){

                        // если вернулся social_pult_post - то вместо редактора откроем
                        // просмотрщик
                        if (result.social_pult_post && !force) {
                            self.openViewer(materialId, result.social_pult_post);
                            return;
                        }

                        // откроем редактор
                        self.viewer.visible(0);
                        self.editor.visible(1);

                        self.editor.materialId(result.material_id);
                        self.editor.text(result.text);
                        self.editor.url(result.url);

                        self.insertEditorImages(result.images);

                        // если был сохранен черновик
                        if (result.draft) {
                            self.restoreFromDraft(result.draft);
                        }
                        else {
                            // ресет на значения по-умолчанию
                            self.editor.twitterEnabled(false);
                            self.editor.twitterText('');
                            self.editor.facebookEnabled(true);
                            self.editor.odnoklassnikiEnabled(false);
                        }
                        // дату актуализируем
                        self.editor.day('2018-09-03');
                        self.editor.hour((new Date()).getHours());
                        self.editor.minute((new Date()).getMinutes());
                    })
                    .error(function(xhr){
                        self.showHttpError(xhr);
                    });
            };

            /**
             * Восстанавливает редактор в состояние, которое он имел в момент
             * сохранения черновика
             */
            self.restoreFromDraft = function(draft) {
                var data = JSON.parse(draft);

                self.editor.text(data.text);
                self.editor.twitterEnabled(data.twitterEnabled);
                self.editor.twitterText(data.twitterText);
                self.editor.facebookEnabled(data.facebookEnabled);
                self.editor.odnoklassnikiEnabled(data.odnoklassnikiEnabled);
                self.editor.vkontakteEnabled(data.vkontakteEnabled);
                self.editor.url(data.url);

                if (!data.selectedImages || data.selectedImages.length === 0) {
                    // черновик сохранен "без изображения"
                    jQuery('.fotorama').data('fotorama').show('noimage');
                }
                else {
                    var selectedImage = data.selectedImages[0];
                    jQuery('.fotorama').data('fotorama').show(selectedImage.id);
                }
            };

            /**
             * Открывает редактор для создания поста с чистого листа, без привязки
             * к какой-то новости
             */
            self.openEmptyEditor = function() {

                // никакой пункт не светится
                self.lenta.selectedId(0);

                self.viewer.visible(0);
                self.editor.materialId(0);
                self.editor.visible(1);
            };


            self.closeEditor = function() {
                self.editor.visible(false);
                self.lenta.selectedId(0);
                self.lenta.load();
            };

            self.publish = function() {
                // сначала сохраним
                self.editor.save(self.editor, {});

                var data = self.editor.asJson();
                var url = PUBLISH_POST_URL.replace('000', self.editor.materialId());
                jQuery.post(url, JSON.stringify(data), function(response){
                    if (response.ok) {
                        self.closeEditor();
                        self.openEditor(response.material_id);
                    } else {
                        // todo: alert error
                    }
                });
            };
        }


        /**
         * Модель ленты новостей слева
         */
        var lentaViewModel = function(){
            var self = this;

            this.newsLenta = ko.observableArray();
            this.selectedId = ko.observable();
            this.paginationButtons = ko.observableArray([]);
            this.q = ko.observable('');

            this.paginationStart = NaN;
            this.paginationLimit = NaN;
            this.currentPage = ko.observable(1);
            this.totalElements = ko.observable(NaN);
            this.totalPages = ko.observable(0);

            this.init = function(){
                self.load();
            };

            // при клике в ленте открывается редактор (или вьюер)
            this.clickLentaItem = function(lentaItem){
                console.log('clickLentaItem:', lentaItem);
                app.openEditor(lentaItem.material_id);
            };

            this.load = function(){
                var params = {};

                if (self.q) params.q = self.q;  // поисковый запрос
                if (self.paginationStart) params.start = self.paginationStart;
                if (self.paginationLimit) params.limit = self.paginationLimit;

                jQuery.getJSON(LIST_NEWS_URL, params).then(function(result) {
                    self.newsLenta.removeAll();
                    self.insertItems(result);
                    self.insertPagination(result);
                });
            };

            this.insertItems = function(result){
                var items = [];
                for (var i = 0; i < result.materials.length; i++) {
                    var item = ko.observable(result.materials[i]);
                    items.push(item);
                }

                ko.utils.arrayPushAll(self.newsLenta, items);
            };

            function Paginator(total, pageSize) {
                var self = this;
                this.total = parseInt(total, 10);
                this.pageSize = parseInt(pageSize, 10);

                /**
                 * Определяет, к какой странице относится элемент с номером start
                 * start - 0-based index, который используется в SQL
                 */
                this.getPageNumber = function(start) {
                    return parseInt(start / this.pageSize) + 1;
                };

                this.getTotalPages = function() {
                    return Math.ceil(this.total / this.pageSize);
                };
            };
            window.Paginator = Paginator;


            this.insertPagination = function(result){
                var pagination = result.pagination;
                self.pagination = result.pagination;
                self.paginationButtons.removeAll();

                paginator = new Paginator(pagination.total, pagination.limit);
                self.currentPage(paginator.getPageNumber(pagination.start));
                console.log('currentPage:', self.currentPage());

                // покажем общее число элементов и страниц
                self.totalElements(pagination.total);
                self.totalPages(paginator.getTotalPages());
            };

            this.paginate = function(start, limit){
                self.paginationStart = start;
                self.paginationLimit = limit;
                self.load();
            };

            this.pageBackward = function(){
                var start = self.pagination.limit * (this.currentPage() - 1 - 1);
                self.paginate(start, self.pagination.limit);
            };

            this.pageForward = function(){
                var start = self.pagination.limit * (this.currentPage() - 1 + 1);
                self.paginate(start, self.pagination.limit);
            };

            // Когда пользователь набирает что-то в поле поиска, обновляем ленту
            this.q.subscribe(function(newValue){
                // при изменении поиска сбросим пейджинацию в 1
                self.paginationStart = 0;
                self.load();
            });
        };

        /**
         * Окошко, которое показывается, пока новость публикуется
         */
        var progressViewModel = function(){
            var self = this;
            self.visible = ko.observable(false);
            self.errorHeader = ko.observable('');
            self.errorText = ko.observable('');
        };


        /**
         * Просмотрщик опубликованных новостей
         */
        var viewerViewModel = {
            materialId: ko.observable(),
            socialPultPostId: ko.observable(),
            visible: ko.observable(false),
            publishing: ko.observable(false),
            facebookEnabled: ko.observable(false),
            odnoklassnikiEnabled: ko.observable(false),
            twitterEnabled: ko.observable(false),
            text: ko.observable(''),
            twitterText: ko.observable(''),
            url: ko.observable(''),
            selectedImage: ko.observable(),
            status: ko.observable(),
            progress: ko.observable({}),

            networks: [{key: 'facebook', title: 'Facebook'},
                       {key: 'odnoklassniki', title: 'Одноклассниках'},
                       {key: 'twitter', title: 'Твиттере'},
                       {key: 'vkontakte', title: 'Вконтакте'}]
        };

        viewerViewModel.getIndexedProgress = function(){
            var indexed = {
                published: [],
                error: [],
                publishing: [],
                scheduled: []
            };

            for (var i = 0; i < this.networks.length; i++) {
                var network = this.networks[i].key;

                if (this.progress().hasOwnProperty(network)) {
                    var networkProgress = this.progress()[network];
                    indexed[networkProgress.status].push(networkProgress);
                }
            }

            return indexed;
        };

        // заголовок для вьюера - опубликовано, ошибка, etc
        viewerViewModel.header = ko.computed(function(){
            var parts = [];
            var indexed = {
                published: [],
                error: [],
                publishing: [],
                scheduled: []
            };

            for (var i = 0; i < this.networks.length; i++) {
                var network = this.networks[i].key;

                if (this.progress().hasOwnProperty(network)) {
                    var networkProgress = this.progress()[network];
                    indexed[networkProgress.status].push(networkProgress);
                }
            }

            if (indexed.published.length && !indexed.error.length && !indexed.publishing.length) {
                return 'Опубликовано';
            }
            else if (indexed.publishing.length && !indexed.error.length && !indexed.published.length) {
                return 'Публикуется...';
            }
            else if (indexed.error.length && !indexed.published.length && !indexed.publishing.length) {
                return 'Ошибка публикации';
            }
            else if (indexed.scheduled.length) {
                return 'Запланировано';
            }
            else {
                if (indexed.published.length) {
                    parts.push(indexed.published.length + ' опубликовано');
                }
                else if (indexed.error.length) {
                    parts.push(indexed.error.length + ' с ошибкой');
                }
                else if (indexed.publishing.length) {
                    parts.push(indexed.publishing.length + ' публикуется');
                }

                return parts.join(', ');
            }

        }, viewerViewModel);


        viewerViewModel.canEdit = ko.computed(function() {
            if (this.progress) {
                var indexed = this.getIndexedProgress();
                if (indexed.publishing.length == 0)
                    return true;
            }
            return false;
        }, viewerViewModel);

        viewerViewModel.selectedImageUrl = ko.computed(function(){
            var img = viewerViewModel.selectedImage();
            if (img) {
                return img.original;
            } else {
                return '';
            }
        });

        viewerViewModel.isPublishing = function(network){
            var progress = viewerViewModel.progress();
            if (progress && progress[network]) {
                return progress[network].status === 'publishing';
            }
            return false;
        };

        viewerViewModel.isPublished = function(network){
            var progress = viewerViewModel.progress();
            if (progress && progress[network]) {
                return progress[network].status === 'published';
            }
            return false;
        };

        viewerViewModel.isScheduled = function(network){
            var progress = viewerViewModel.progress();
            if (progress && progress[network]) {
                return progress[network].status === 'scheduled';
            }
            return false;
        };

        viewerViewModel.isError = function(network){
            var progress = viewerViewModel.progress();
            if (progress && progress[network]) {
                return progress[network].status === 'error';
            }
            return false;
        };

        viewerViewModel.getLink = function(network) {
            var progress = viewerViewModel.progress();
            if (progress && progress[network]) {
                return progress[network].link;
            }
        };

        viewerViewModel.getError = function(network) {
            var progress = viewerViewModel.progress();
            if (progress && progress[network]) {
                return progress[network].error;
            }
        };

        viewerViewModel.getProgressWhen = function(network) {
            var progress = viewerViewModel.progress();
            if (progress && progress[network] && progress[network].when) {
                var date = new Date(progress[network].when);

                var day = date.getDate() < 10 ? '0'+date.getDate() : date.getDate();
                var month = date.getMonth() + 1;
                month = month < 10 ? '0' + month : month;
                var year = date.getFullYear();
                var hour = date.getHours() < 10 ? '0'+date.getHours() : date.getHours();
                var minutes = date.getMinutes() < 10 ? '0'+date.getMinutes() : date.getMinutes();

                return day + '.' + month + '.' + year + ' ' + hour + ':' + minutes;
            }
        };

        viewerViewModel.refresh = function() {
            viewerViewModel.app.openViewer(this.materialId(), this.socialPultPostId());
        };

        viewerViewModel.edit = function() {
            viewerViewModel.app.openEditor(this.materialId(), 1);
        };


        /**
         * Модель редактора
         */
        var editorViewModel = {
            visible: ko.observable(false),
            materialId: ko.observable(),
            facebookEnabled: ko.observable(false),
            odnoklassnikiEnabled: ko.observable(false),
            twitterEnabled: ko.observable(false),
            vkontakteEnabled: ko.observable(false),
            text: ko.observable(''),
            twitterText: ko.observable(''),
            url: ko.observable(''),
            images: ko.observableArray([]),
            fileuploadError: ko.observable(''),
            day: ko.observable(),
            hour: ko.observable(),
            minute: ko.observable(),

            imageFrames: [],
            app: null,

            asJson: function(save) {
                // сериализует данные для отправки поста на сервер

                if (save) {
                    // для сохранения черновика используем другой формат
                    // потому что серверу для публикации важно знать о каждой сети отдельно,
                    // а редактору для восстановления состояния нужно только знать общий текст
                    var result = {
                        'id': this.materialId(),
                        'text': this.text(),
                        'selectedImages': this.selectedImages(),
                        'twitterEnabled': this.twitterEnabled(),
                        'vkontakteEnabled': this.vkontakteEnabled(),
                        'twitterText': this.twitterText(),
                        'facebookEnabled': this.facebookEnabled(),
                        'odnoklassnikiEnabled': this.odnoklassnikiEnabled(),
                        'url': this.url(),
                    }
                    return result;
                }

                var result = {
                    'id': this.materialId(),
                    'url': this.url(),
                    'text': this.text(),
                    'selected_images': this.selectedImages(),
                    'day': this.day(),
                    'hour': this.hour(),
                    'minute': this.minute()
                };

                if (this.facebookEnabled()) {
                    result.facebook = {
                        'text': this.text(),
                        'images': this.selectedImages()
                    };
                }
                if (this.odnoklassnikiEnabled()) {
                    result.odnoklassniki = {
                        'text': this.text(),
                        'images': this.selectedImages()
                    };
                }
                if (this.vkontakteEnabled()) {
                    result.vkontakte = {
                        'text': this.text(),
                        'images': this.selectedImages()
                    };
                }
                if (this.twitterEnabled()) {
                    result.twitter_text = this.twitterText();
                    result.twitter = {
                        'text': this.twitterText(),
                        'images': this.selectedImages()
                    };
                }

                return result;
            },

            // возвращает массив выбранных изображений (пока одно только)
            // из images
            selectedImages: function() {
                var fr = jQuery('.fotorama').data('fotorama').activeFrame;
                var activeImageId = fr.id;

                if (activeImageId === 'noimage') {
                    console.info('No image selected')
                    return [];
                }

                for (var i = 0; i < this.images().length; i++) {
                    if (this.images()[i].id == activeImageId)
                        return [this.images()[i]];
                }

                return [];
            },

            save: function(self, event) {
                var data = self.asJson(true);
                console.log('Saving post:', data);

                var params = {
                    'material_id': self.materialId(),
                    'data': JSON.stringify(data)
                };

                var url = SAVE_DRAFT_URL.replace('000', self.materialId());
                jQuery.post(url, params, function(response){
                    console.log(response);
                });
            },

            imageUploadUrl: function() {
                if (this.materialId() === 0) {
                    // этот редактор открыт пустым, не для какой-то новости
                    return UPLOAD_IMAGE_URL.replace('000', '0');
                } else if (this.materialId() > 0) {
                    return UPLOAD_IMAGE_URL.replace('000', this.materialId());
                } else {
                    throw Error('такого быть не должно');
                }
            }
        };

        editorViewModel.submitButtonLabel = ko.computed(function() {
            var date = new Date(editorViewModel.day());
            date.setHours(editorViewModel.hour());
            date.setMinutes(editorViewModel.minute());
            var diff = new Date() - date;
            if (diff < -60*5) {
                return 'Запланировать';
            } else {
                return 'Опубликовать';
            }
        });

        editorViewModel.publish = function(self, event) {
            self.app.publish();
        };

        editorViewModel.twitterEnabled.subscribe(function(newValue) {
            if (newValue == true) {
                // скопируем в твиттер текст из основного поля
                editorViewModel.twitterText(editorViewModel.text());

                // setTimeout(function(){
                //     document.getElementById('twitter_text_input').focus();
                // }, 0);
            }
        });

        editorViewModel.canSubmit = ko.computed(function() {
            return this.facebookEnabled() ||
                this.odnoklassnikiEnabled() ||
                this.vkontakteEnabled() ||
                this.twitterEnabled();
        }, editorViewModel);

        //
        // Изменения в images отображаются в фотораме
        //
        editorViewModel.images.subscribe(function(images){
            console.log('Updating images:', images);
            var frames = [];
            for (var i = 0; i < images.length; i++) {
                frames.push(imageToFrame(images[i]));
            }

            if (frames.length) {
                var $fotoramaDiv = jQuery('.fotorama').fotorama();
                var fotorama = $fotoramaDiv.data('fotorama');
                fotorama.load(frames);
                fotorama.show(0);
            }
        });

        // По объекту из массива images с бекенда строит frame, пригодный для инсерта
        // в фотораму. Для видео один формат, для картинок другой
        function imageToFrame(image) {
            var frame = {'id': image.id};
            frame['img'] = image.original;
            if (image.media_type === 'video') {
                frame['video'] = image.original;
            } else {
                frame['img'] = image.original;
            }

            return frame;
        }

        function textAreaAdjust(o) {
            o.style.height = "1px";
            o.style.height = (25+o.scrollHeight)+"px";
        }

        // Поехали
        jQuery(function(){
            app = new App();
            app.init();
        });
    </script>
{% endblock %}

{% comment %} <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script> {% endcomment %}


{% block content %}
<div class="container-fluid">
    <div class="row">
        <div id="Lenta" class="col-12 col-md-5 col-lg-4 b-lenta">
            <h2>Лента новостей</h2>
            <!-- <div>
                <button data-bind="click: app.openEmptyEditor">Создать пустой пост</button>
            </div> -->
            <div class="search-box">
                <input type="search" class="search-input" placeholder="Поиск" data-bind="textInput:q">
            </div>
            <div data-bind="foreach: newsLenta">
                <div class="media p-2" style="cursor:pointer" data-bind="click: $parent.clickLentaItem, css: {'__active text-white': $parent.selectedId() == material_id}">
                    <div class="media-body">
                        <div data-bind="text: title"></div>
                        <div class="row">
                            <div class="col small" data-bind="text: date[0]+' '+date[1]"></div>
                            <div class="col text-right small" data-bind="text: editor_status"></div>
                        </div>
                        <div class="text-right" ></div>
                    </div>
                </div>
            </div>
            <div class="btn-group" data-bind="foreach: paginationButtons">
                <button type="button" class="btn"
                    data-bind="text: text, click: click, css: {'btn-primary': $parent.currentPage() == page, 'btn-secondary': $parent.currentPage() != page}"
                    ></button>
            </div>
            <div class="b-undernav my-3">
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" data-bind="click:pageBackward">Назад</button>
                    <button type="button" class="btn btn-secondary" data-bind="click:pageForward">Вперед</button>
                </div>
                <span class="navtext"><span data-bind="text:currentPage"></span>/<span data-bind="text:totalPages()"></span></span>
            </div>
        </div>

        <div id="Viewer" class="col-12 col-md-7 col-lg-6 mt-sm-4 mt-md-0" data-bind="visible: visible, attr: {'data-material-id': materialId, 'data-soc-pult-post-id': socialPultPostId}">
            <div class="card" data-bind="visible: publishing">
                <div class="card-header">
                    <h2 data-bind="text: header">Публикуется...</h2>
                </div>
                <div class="card-body">
                    <div class="card-text mb-3" data-bind="text: text"></div>
                    <div class="mb-3" data-bind="visible: twitterText">
                        <span class="text-muted">Твиттер:</span> <span data-bind="text: twitterText"></span>
                    </div>
                    <div class="card-text mb-3" data-bind="visible: selectedImageUrl">
                        <img src="" class="img-fluid" data-bind="attr: {src: selectedImageUrl}">
                    </div>

                    <!-- вывод данных из progress -->
                    <div data-bind="foreach: networks">
                        <div data-bind="visible: $parent.isPublishing(key)">
                            Публикуется в <span data-bind="text: title"></span>
                        </div>
                        <div data-bind="visible: $parent.isScheduled(key)">
                            <span data-bind="text: title"></span>: запланировано на <span data-bind="text: $parent.getProgressWhen(key)"></span>
                        </div>
                        <div data-bind="visible: $parent.isPublished(key)">
                            Опубликовано в <span data-bind="text: title"></span>
                            <a href="" data-bind="attr: {href: $parent.getLink(key)}, text: $parent.getLink(key)"></a>
                        </div>
                        <div data-bind="visible: $parent.isError(key)">
                            Ошибка публикации в <span data-bind="text: title"></span>
                            <pre data-bind="text: $parent.getError(key)"></pre>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-primary" data-bind="visible: !canEdit(), click: refresh">Проверить статус</button>
                    <button class="btn btn-dark" data-bind="visible: canEdit, click: edit">Редактировать</button>
                    <p class="small text-muted mt-2" data-bind="visible: canEdit">
                        Чтобы обновить информацию в соцсетях, удалите там посты, нажмите
                        кнопку "Редактировать" и опубликуйте новость заново.
                    </p>
                </div>
            </div>
        </div>

        <div id="Editor" class="col-12 col-md-7 col-lg-6 mt-sm-4 mt-md-0" data-bind="visible: visible">
            <div class="card">
                <div class="card-header">
                    <h2>Создать новый пост</h2>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" data-bind="checked: facebookEnabled" id="defaultCheck1">
                            <label class="form-check-label" for="defaultCheck1">
                                <strong>Facebook</strong>
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" data-bind="checked: odnoklassnikiEnabled" id="defaultCheck2">
                            <label class="form-check-label" for="defaultCheck2">
                                <strong>Одноклассники</strong>
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" data-bind="checked: vkontakteEnabled" id="defaultCheck3">
                            <label class="form-check-label" for="defaultCheck3">
                                <strong>Вконтакте</strong>
                            </label>
                        </div>
                    </div>

                    <form class="">
                        <div class="form-group">
                            <label for="text_textarea">Дополнительный текст</label>
                            <textarea class="form-control" id="text_textarea" data-bind="value: text" rows="6"
                                      onkeyup="textAreaAdjust(this)" style="overflow:hidden"></textarea>
                        </div>
                        <div class="form-group">
                            <div>
                                <label>
                                    <input type="checkbox" data-bind="checked: twitterEnabled">
                                    <strong>Twitter</strong>
                                </label>
                            </div>
                            <div data-bind="visible: twitterEnabled">
                                <label for="twitter_text_input">Текст для Твиттера</label>
                                <input type="text" class="form-control" id="twitter_text_input" data-bind="value: twitterText">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="url_text_input">Ссылка</label>
                            <input type="text" class="form-control" id="url_text_input" data-bind="value: url">
                        </div>

                        <div class="form-group">
                            <div class="row">
                                <div class="col">
                                    <label>Картинка</label>
                                </div>
                                <div class="col text-right">
                                    <!-- The fileinput-button span is used to style the file input field as button -->
                                    <span class="btn btn-sm fileinput-button" style="margin-top:-3px">
                                        <span>Загрузить файл</span>
                                        <input id="fileupload" type="file" name="image" multiple
                                            data-url="{% url 'admin_social_pult_upload' '000' %}"
                                            data-sequential-uploads="true">
                                    </span>
                                </div>
                            </div>



                            <div id="progress" class="progress">
                                <div class="progress-bar progress-bar-success"></div>
                            </div>
                            <div data-bind="visible:fileuploadError,html:fileuploadError">
                            </div>

                            <div class="fotorama"
                                data-width="100%"
                                data-ratio="845/445"
                                data-nav="thumbs"
                                data-auto="false"></div>
                        </div>
                    </form>
                </div>

                <div class="card-footer">
                    <div class="row">
                        <div class="col">
                            <span class="b-datepicker">
                                <!-- <label><input type="checkbox"> запланировать</label> -->
                                <select class="form-control day-select" name="day" data-bind="value:day">
                                    {% for day in days_ahead %}
                                        <option value="{{ day|date:'Y-m-d' }}">
                                            {% if forloop.first %}
                                                Сегодня
                                            {% else %}
                                                {{ day|date:'d.m.Y' }}
                                            {% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                                <span class="in">в</span>
                                <!-- <input type="text" name="date1" class="day-input" value="{% now "Y-m-d" %}"> -->
                                <!-- <input type="text" name="time1" class="time-input" value="{% now "Y-m-d" %}"> -->
                                <select class="form-control hour-select" name="hour" data-bind="value:hour">
                                    {% for h in hours %}
                                        <option value="{{ h }}">{{ h }}</option>
                                    {% endfor %}
                                </select>
                                :
                                <select class="form-control minute-select" name="minute" data-bind="value:minute">
                                    {% for m in minutes %}
                                        <option value="{{ m }}">{{ m }}</option>
                                    {% endfor %}
                                </select>
                            </span>
                        </div>
                        <div class="col text-right">
                            <button class="btn btn-secondary" data-bind="click: save">Сохранить</button>
                            <button href="#" class="btn btn-primary text-white" data-bind="enable: canSubmit, click: publish">
                                <span class="mr-1" data-bind="text:submitButtonLabel">Опубликовать</span>
                                <i class="fab fa-facebook-square" data-bind="visible: facebookEnabled"></i>
                                <i class="fab fa-odnoklassniki-square" data-bind="visible: odnoklassnikiEnabled"></i>
                                <i class="fab fa-vk" data-bind="visible: vkontakteEnabled"></i>
                                <i class="fab fa-twitter-square" data-bind="visible: twitterEnabled"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="Progress" class="col-12 col-md-7 col-lg-6 mt-sm-4 mt-md-0" data-bind="visible: visible">
            <div data-bind="visible: !errorHeader">
                Загружаю данные...
            </div>
            <div data-bind="visible: errorHeader" class="alert alert-danger">
                <h2 data-bind="text: errorHeader"></h2>
                <pre data-bind="text: errorText"></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}
